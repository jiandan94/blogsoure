---
title: "RStudio-Server与远程交互"
date: 2020-07-05
toc: true
categories:
  - R语言
tags:
  - R语言
  - 算法
---


## 0 写在前面

作为经常用`R`跑程序、处理数据的你是否有过这样的苦恼：台式机性能强大但携带不便，笔记本携带自如但性能薄弱，每次只能在两台电脑间来回操作、疲惫不已却无能为力。

那这样的场景多半会吸引到你：在有网络的地方，通过笔记本可以轻松的访问远程的`R`客户端，利用远程电脑运行程序；若程序比较耗时，你尽可以将`R`界面关闭去用笔记本处理其他事务，只用再次连接远程电脑就可以查看程序的运行情况.....

现在有很多云服务器可以实现上述的工作情景，不过可能价格不菲。但如果你手上恰有一台台式机+笔记本，以上情景可以通过`RStudio-Server`实现。本文就跟大家分享一下`RStudio-Server`环境的搭建经验。


## 1 准备工作
### 1.1 Ubuntu系统
一般来说，`Linux`系统在处理程序时相较于`Windows`系统更高效，服务器端环境的搭建常常是在`Linux`上展开的。因此，我们首先要在台式机上安装`Linux`系统。目前比较流行的`Linux`系统版本有很多，例如受美国打压后国内热度迅速上升的`deepin`，我在好友H君的建议选择了`Ubuntu 18.04`，因为`Ubuntu`发展至今系统较为稳定，社区也很成熟，很多坑和雷都可以在网上找到解决方案。

> 事实上，作为一个爱国青年我最开始也尝试了`deepin`，桌面颜值很高但系统还不是很流畅。致命的问题是在安装`RStudio-Server`时，总报错`OpenSSL`版本不对，试了网上几乎所有的方法皆以失败告终。无奈，放弃。

`Ubuntu`系统的安装也很简单。首先，我们在[`Ubuntu`官网](https://ubuntu.com/download)下载对应的版本镜像`iso`文件；官网的下载速度可能比较慢，我们可以选在国内的镜像源进行下载，以下是我搜集的一些常见下载镜像源，进入后选择对应的版本即可。

```r
# 中国官网（推荐）
https://cn.ubuntu.com/

# 中科大源
http://mirrors.ustc.edu.cn/ubuntu-releases

# 阿里云开源镜像站
http://mirrors.aliyun.com/ubuntu-releases

# 兰州大学开源镜像站
http://mirror.lzu.edu.cn/ubuntu-releases

# 北京理工大学开源
http://mirror.bit.edu.cn/ubuntu-releases

# 浙江大学
http://mirrors.zju.edu.cn/ubuntu-releases
```

其次，我们在网上下载软**碟通UltraISO**软件，利用该软件进行装机启动U盘的制作。具体的制作过程可以问度娘，步骤很简单。

![](/rstudio-server/ultraiso.png)

最后，我们利用制作好的装机U盘进行系统安装。这个过程网上很多教程可参考，不过还是可能遇到一些不可控的问题。例如，我在安装的过程中就报错。好在网上有对应解决的策略，这也说明选择一个成熟的系统就是为自己省心。

> 安装系统只用记住一件事，设置好系统的**用户名**和**密码**并牢记！

### 1.2 安装`R`和`RStudio-Server`
系统安装好之后，连上网，然后就可以着手安装`R`和`RStudio-Server`两个客户端——工欲善其事必先利其器嘛。

首先按住`Ctrl+Alt+T`快捷键呼出终端——这相当于系统的一个控制台，功能相当强大。用户可以通过终端输入命令进行各种操作，如网页访问、文件下载、文件解压、程序安装、各种环境部署等。

![](/rstudio-server/terminal.png)

虽然`Ubuntu`提供了很多可视化的工具，但是作为一个有理想的小白，我还是觉得适应`Linux`就要从适应命令行开始！输入下面的命令安装`r`环境

```r
# 更新软件源
apt-get update 
# 安装r
apt-get install r-base r-base-dev
```

安装完毕后，在终端输入`R`返回下面的结果就说明安装成功。

![](/rstudio-server/R.png)

上面的返回结果其实就是`R`的操作环境 (和我们在`Windows`上的图形界面看到的结果一样)，我们可以接着输入`R`程序运行即可。例如，我输入了下面的命令进行画图，就会返回相应的图像。

![](/rstudio-server/r-example.png)

接着，我们继续在终端中依次输入下面的命令进行`RStudio-Sever`安装。与桌面版的`RStudio`不同，服务器版提供了远程网页的访问功能，使用起来更加方便。

```r
# 安装必备文件
sudo apt-get install gdebi-core
# 下载1.0.136版的rstudio-server安装文件，最新版自行去官网查看
wget https://download2.rstudio.org/rstudio-server-1.0.136-amd64.deb
# 进行安装
sudo gdebi rstudio-server-1.0.136-amd64.deb
```

我们输入如下的命令测试安装情况

```r
# 开启rstudio-server
sudo rstudio-server start
# 查看rstudio-server状态
rstudio-server status
```

由于我的`RStudio-Sever`已在运行，这里只给大家展示运行状态，可见显示为`Active`，表明`RStudio-Sever`正在运行中。

![](/rstudio-server/rstudio-status.png)

你此时可能一脸懵逼，因为电脑上并没有看到`RStudio`的界面。前面说过，服务器版的`RStudio`是通过网络进行访问，它的端口号为8787，在本地计算机上只用在浏览器上输入`ip:8787`或者`localhost:8787`就可以看到图形界面。如果你可以看到，就说明你已经建好`RStudio-Sever`环境。

![](/rstudio-server/rserver-sign.png)

我们可以看到`RStudio`初始界面需要用账号密码登录，这个账号密码就是安装系统时设置的用户名和密码。我们输入后，就可以看到熟悉的操作界面了

此时，你可以对其进行个性化设置，例如界面的布局、主题、字体；你也可以进行程序的下载和安装等等，这些操作如同`Windows`上一样，没有任何迁移的成本。


## 2 配置远程访问环境
### 2.1 问题分析
看到这里，折腾一圈，似乎也没有看出和`Windows`端`RStudio`有多大区别，而且在另外一台电脑上输入`ip:8787`或者`localhost:8787`也无法访问。现在，我们就开始着手配置远程访问的环境。

配置之前，我们要明白一个问题，为什么输入`ip:8787`或者`localhost:8787`无法访问服务器上的`RStudio-Sever`呢？因为通常情况下，我们每个人的网络环境都不是公网IP地址。所谓公网IP地址，可以简单的理解成全球唯一网络识别身份证号，在任何地方输入它就能访问对方。

可惜，公网IP很稀缺，不是人人都有，这时就要知道内网的概念。以我们学校为例，学校有公网IP地址，但学校内部众多师生上网怎么互相识别身份？此时，我们可以通过交换机生成内网IP地址，这个地址在学校内部可以互相区别，但出学校后就无法访问了。

上述的`ip`是内网地址，我们通过外网无法访问，从而不能实现远程操作的目的。因此，我们需要解决IP地址的问题。

### 2.2 花生壳内网穿透
一个简单的解决策略就是，利用花生壳软件进行内网穿透，也即是生成一个可以被外网识别的IP地址。如何实现呢？

首先，我们在服务器端安装花生壳软件。第一步，访问[花生壳官网](https://hsk.oray.com/download/)下载安装文件。第二步，按照官方的[安装说明](http://service.oray.com/question/4287.html)进行安装。第三步，按照官方的[安装说明](http://service.oray.com/question/4287.html)登录进行设置。

> 如果SN码不能正常登陆，可以使用手机号注册账户，然后用手机号登陆，再选择添加设备输入SN号绑定即可。

然后，我们在花生壳管理界面上选择增加映射，其中应用名称和应用图标可以随便取，只需注意填对服务器的IP地址和`RStudio-Sever`的端口号：服务器IP地址在终端输入`ifconfig -a`回车，返回的`inet`后面即是本地IP地址；`RStudio-Sever`的端口号为8787.

![](/rstudio-server/ip-map.png)

最后，我们在服务的终端上输入

```r
sudo phddns start
phddns status
````

返回下面的就说明本地的花生壳已经在运行。

![](/rstudio-server/phddns.png)

我们回到花生壳管理界面打开映射即可，此时我们就可以通过上述显示的的访问地址来进行`RStudio-Sever`的远程访问了。

![](/rstudio-server/phddns-start.png)

在另外一台电脑的浏览器上输入上述访问地址，可以看到，我们能够从其他位置访问该服务器 (注意访问的IP地址是花生壳生成的)。

![](/rstudio-server/rserver-remote.png)

至此，我们终于实现一台笔记本走天下，重活累活都不怕的小目标了！！！


## 3 写在最后
限于篇幅，很多问题在这里不能详尽介绍。例如，`Ubuntu`系统安装可能遇到的坑，花生壳内网映射设置的详细步骤等等，不过这些都可以通过上网快速找到解决方案，故而没有赘述。

此外，关于`RStudio-Sever`本身，还有很多重要的问题需要读者自行摸索。例如，如何设置群组实现一个团队共同协作？实现不同账户之间的相对独立？例如，本地的代码如何同服务器端有效对接？例如，本地的数据表格如何同服务器端有效的互传？等等，都是在实际中常常面临的问题，这都需要读者自行去探索。